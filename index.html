<!doctype html>
<html class="theme-next use-motion ">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  
    <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  


<link rel="stylesheet" type="text/css" href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" />

<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.2"/>




  <meta name="keywords" content="Hexo, NexT" />





  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />


<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Scarletsky">
<meta property="og:url" content="http://scarletsky.github.io/index.html">
<meta property="og:site_name" content="Scarletsky">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Scarletsky">
<meta name="twitter:description">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post'
  };
</script>



  <title> Scarletsky </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Scarletsky</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/10/22/2015-10-22-node-stream-api-learning/" itemprop="url">
                  Node.js 中 Stream API 的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-10-22T17:09:06+08:00" content="2015-10-22">
              2015-10-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/10/22/2015-10-22-node-stream-api-learning/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/10/22/2015-10-22-node-stream-api-learning/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="基本介绍">基本介绍</h2><p>在 Node.js 中，读取文件的方式有两种，一种是用 <code>fs.readFile</code>，另外一种是利用 <code>fs.createReadStream</code> 来读取。</p>
<p><code>fs.readFile</code> 对于每个 Node.js 使用者来说最熟悉不过了，简单易懂，很好上手。但它的缺点是会先将数据全部读入内存，一旦遇到大文件的时候，这种方式读取的效率就非常低下了。</p>
<p>而 <code>fs.createReadStream</code> 则是通过 Stream 来读取数据，它会把文件（数据）分割成小块，然后触发一些特定的事件，我们可以监听这些事件，编写特定的处理函数。这种方式相对上面来说，并不好上手，但它效率非常高。</p>
<p>事实上， Stream 在 Node.js 中并非仅仅用在文件处理上，其他地方也可以看到它的身影，如 <code>process.stdin/stdout</code>, <code>http</code>, <code>tcp sockets</code>, <code>zlib</code>, <code>crypto</code> 等都有用到。</p>
<p>本文是我学习 Node.js 中的 Stream API 中的一点总结，希望对大家有用。</p>
<h2 id="特点">特点</h2><ul>
<li>基于事件通讯</li>
<li>可以通过 <code>pipe</code> 来连接流</li>
</ul>
<h2 id="种类">种类</h2><ul>
<li>Readable Stream  可读数据流</li>
<li>Writeable Stream  可写数据流</li>
<li>Duplex Stream  双向数据流，可以同时读和写</li>
<li>Transform Stream 转换数据流，可读可写，同时可以转换（处理）数据</li>
</ul>
<h2 id="事件">事件</h2><h3 id="可读数据流的事件">可读数据流的事件</h3><ul>
<li><code>readable</code> 数据向外流时触发</li>
<li><code>data</code> 对于那些没有显式暂停的数据流，添加data事件监听函数，会将数据流切换到流动态，尽快向外提供数据</li>
<li><code>end</code> 读取完数据时触发。注意不能和 <code>writeableStream.end()</code> 混淆，writeableStream 并没有 end 事件，只有 <code>.end()</code> 方法</li>
<li><code>close</code> 数据源关闭时触发</li>
<li><code>error</code> 读取数据发生错误时触发</li>
</ul>
<h3 id="可写数据流的事件">可写数据流的事件</h3><ul>
<li><code>drain</code> <code>writable.write(chunk)</code> 返回 false 之后，缓存全部写入完成，可以重新写入时就会触发</li>
<li><code>finish</code> 调用 <code>.end</code> 方法时，所有缓存的数据释放后触发，类似于可读数据流中的 <strong>end</strong> 事件，表示写入过程结束</li>
<li><code>pipe</code> 作为 pipe 目标时触发</li>
<li><code>unpipe</code> 作为 unpipe 目标时触发</li>
<li><code>error</code> 写入数据发生错误时触发</li>
</ul>
<h2 id="状态">状态</h2><p>可读数据流有两种状态：<strong>流动态</strong> 和 <strong>暂停态</strong>，改变数据流状态的方法如下：</p>
<p><strong>暂停态 -&gt; 流动态</strong></p>
<ul>
<li>添加 data 事件的监听函数</li>
<li>调用 resume 方法</li>
<li>调用 pipe 方法</li>
</ul>
<p><strong>注意：</strong> 如果转为流动态时，没有 data 事件的监听函数，也没有 pipe 方法的目的地，那么数据将遗失。</p>
<p><strong>流动态 -&gt; 暂停态</strong></p>
<ul>
<li>不存在 pipe 方法的目的地时，调用 pause 方法</li>
<li>存在 pipe 方法的目的地时，移除所有 data 事件的监听函数，并且调用 unpipe 方法，移除所有 pipe 方法的目的地</li>
</ul>
<p><strong>注意：</strong> 只移除 data 事件的监听函数，并不会自动引发数据流进入「暂停态」。另外，存在 pipe 方法的目的地时，调用 pause 方法，并不能保证数据流总是处于暂停态，一旦那些目的地发出数据请求，数据流有可能会继续提供数据。</p>
<h2 id="用法">用法</h2><h3 id="读写文件">读写文件</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="comment">// 新建可读数据流</span></span><br><span class="line"><span class="keyword">var</span> rs = fs.createReadStream(<span class="string">'./test1.txt'</span>);</span><br><span class="line"><span class="comment">// 新建可写数据流</span></span><br><span class="line"><span class="keyword">var</span> ws = fs.createWriteStream(<span class="string">'./test2.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听可读数据流结束事件</span></span><br><span class="line">rs.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'read text1.txt successfully!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 监听可写数据流结束事件</span></span><br><span class="line">ws.on(<span class="string">'finish'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'write text2.txt successfully!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 把可读数据流转换成流动态，流进可写数据流中</span></span><br><span class="line">rs.pipe(ws);</span><br></pre></td></tr></table></figure>
<h3 id="读取_CSV_文件，并上传数据（我在生产环境中写过）">读取 CSV 文件，并上传数据（我在生产环境中写过）</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> es = <span class="built_in">require</span>(<span class="string">'event-stream'</span>);</span><br><span class="line"><span class="keyword">var</span> csv = <span class="built_in">require</span>(<span class="string">'csv'</span>);</span><br><span class="line"><span class="keyword">var</span> parser = csv.parse();</span><br><span class="line"><span class="keyword">var</span> transformer = csv.transform(<span class="function"><span class="keyword">function</span>(<span class="params">record</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> record.join(<span class="string">','</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data = fs.createReadStream(<span class="string">'./demo.csv'</span>);</span><br><span class="line">data</span><br><span class="line">    .pipe(parser)</span><br><span class="line">    .pipe(transformer)</span><br><span class="line">    <span class="comment">// 处理前一个 stream 传递过来的数据</span></span><br><span class="line">    .pipe(es.map(<span class="function"><span class="keyword">function</span>(<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">        upload(data, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">            callback(err);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="comment">// 相当于监听前一个 stream 的 end 事件</span></span><br><span class="line">    .pipe(es.wait(<span class="function"><span class="keyword">function</span>(<span class="params">err, body</span>) </span>&#123;</span><br><span class="line">        process.stdout.write(<span class="string">'done!'</span>);</span><br><span class="line">    &#125;));</span><br></pre></td></tr></table></figure>
<h3 id="更多用法">更多用法</h3><p>可以参考一下 <a href="https://github.com/jeresig/node-stream-playground" target="_blank" rel="external">https://github.com/jeresig/node-stream-playground</a> ，进去示例网站之后直接点 add stream 就能看到结果了。</p>
<h2 id="常见坑">常见坑</h2><ul>
<li>用 <code>rs.pipe(ws)</code> 的方式来写文件并不是把 rs 的内容 append 到 ws 后面，而是直接用 rs 的内容覆盖 ws 原有的内容</li>
<li>已结束/关闭的流不能重复使用，必须重新创建数据流</li>
<li><p>pipe 方法返回的是目标数据流，如 <code>a.pipe(b)</code> 返回的是 b，因此监听事件的时候请注意你监听的对象是否正确</p>
<ul>
<li><p>如果你要监听多个数据流，同时你又使用了 pipe 方法来串联数据流的话，你就要写成：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">data</span><br><span class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'data end'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .pipe(a)</span><br><span class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'a end'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .pipe(b)</span><br><span class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'b end'</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="常用类库">常用类库</h2><ul>
<li><a href="https://github.com/dominictarr/event-stream" target="_blank" rel="external">event-stream</a> 用起来有函数式编程的感觉，个人比较喜欢</li>
<li><a href="https://github.com/sindresorhus/awesome-nodejs#streams" target="_blank" rel="external">awesome-nodejs#streams</a> 由于其他 stream 库我都没用过，所以有需求的就直接看这里吧</li>
</ul>
<h2 id="参考资料">参考资料</h2><p><a href="http://javascript.ruanyifeng.com/nodejs/stream.html" target="_blank" rel="external">阮一峰 - stream接口</a><br><a href="https://nodejs.org/api/stream.html" target="_blank" rel="external">nodejs.org Stream</a><br><a href="http://codewinds.com/blog/2013-08-20-nodejs-transform-streams.html" target="_blank" rel="external">Transforming data with Node.js transform streams</a><br><a href="http://stackoverflow.com/questions/18335499/nodejs-whats-the-difference-between-a-duplex-stream-and-a-transform-stream" target="_blank" rel="external">NodeJS: What’s the difference between a Duplex stream and a Transform stream?</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/08/27/2015-08-27-expressjs-source-code-learning-Router/" itemprop="url">
                  ExpressJS 源码学习 —— Router 篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-08-27T00:36:54+08:00" content="2015-08-27">
              2015-08-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/27/2015-08-27-expressjs-source-code-learning-Router/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/27/2015-08-27-expressjs-source-code-learning-Router/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="概述">概述</h1><p>Router 分为三个部分，分别是：Layer, Route, Router。</p>
<h1 id="Layer">Layer</h1><h2 id="构造函数">构造函数</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Layer</span>(<span class="params">path, options, fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Layer)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Layer(path, options, fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'new %s'</span>, path);</span><br><span class="line">  <span class="comment">// Route 中会传一个空的对象进来</span></span><br><span class="line">  <span class="keyword">var</span> opts = options || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.handle = fn;</span><br><span class="line">  <span class="keyword">this</span>.name = fn.name || <span class="string">'&lt;anonymous&gt;'</span>;</span><br><span class="line">  <span class="keyword">this</span>.params = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// 不会受到传进来的 path 的影响</span></span><br><span class="line">  <span class="comment">// 这个值会在 layer.match(path) 中修改</span></span><br><span class="line">  <span class="keyword">this</span>.path = <span class="literal">undefined</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 定义 this.keys</span></span><br><span class="line">  <span class="comment">// pathRegexp(path, keys, options) 会把路径转换成正则表达式，express 通过这个库来解析路由</span></span><br><span class="line">  <span class="comment">// 转换后，this.regexp 为正则表达式，如果 path 中带有 express 路由风格的参数(/:foo/:bar)，则 this.keys 会变成 [&#123;name: 'foo'...&#125;, &#123;name: 'bar'...&#125;]，如果没有匹配的话，则 this.keys 就会是空数组</span></span><br><span class="line">  <span class="comment">// 如果想知道更多这个库的信息，请到 https://github.com/pillarjs/path-to-regexp</span></span><br><span class="line">  <span class="keyword">this</span>.regexp = pathRegexp(path, <span class="keyword">this</span>.keys = [], opts);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// router.route 中会把 opts.end 设置成 true</span></span><br><span class="line">  <span class="keyword">if</span> (path === <span class="string">'/'</span> &amp;&amp; opts.end === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.regexp.fast_slash = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Layer-prototype-handle_error_处理错误">Layer.prototype.handle_error 处理错误</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Handle the error for the layer.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;Error&#125; error</span><br><span class="line"> * @param &#123;Request&#125; req</span><br><span class="line"> * @param &#123;Response&#125; res</span><br><span class="line"> * @param &#123;function&#125; next</span><br><span class="line"> * @api private</span><br><span class="line"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// route.dispatch 中调用这个方法</span></span><br><span class="line">Layer.prototype.handle_error = <span class="function"><span class="keyword">function</span> <span class="title">handle_error</span>(<span class="params">error, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fn = <span class="keyword">this</span>.handle;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fn 必须要有 4 个参数</span></span><br><span class="line">  <span class="keyword">if</span> (fn.length !== <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="comment">// not a standard error handler</span></span><br><span class="line">    <span class="keyword">return</span> next(error);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fn(error, req, res, next);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    next(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Layer-prototype-handle_request_处理请求">Layer.prototype.handle_request 处理请求</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Handle the request for the layer.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;Request&#125; req</span><br><span class="line"> * @param &#123;Response&#125; res</span><br><span class="line"> * @param &#123;function&#125; next</span><br><span class="line"> * @api private</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// route.dispatch 中会调用这个方法</span></span><br><span class="line">Layer.prototype.handle_request = <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> fn = <span class="keyword">this</span>.handle;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fn 如果参数多余三个，那么它就不是一个标准的处理器</span></span><br><span class="line">  <span class="keyword">if</span> (fn.length &gt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="comment">// not a standard request handler</span></span><br><span class="line">    <span class="keyword">return</span> next();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fn(req, res, next);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    next(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Layer-prototype-match_检查是否匹配指定路径，同时会把获取_URL_中变量的实际值">Layer.prototype.match 检查是否匹配指定路径，同时会把获取 URL 中变量的实际值</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Check if this route matches `path`, if so</span><br><span class="line"> * populate `.params`.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;String&#125; path</span><br><span class="line"> * @return &#123;Boolean&#125;</span><br><span class="line"> * @api private</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line">Layer.prototype.match = <span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 检查路径</span></span><br><span class="line">  <span class="keyword">if</span> (path == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// no path, nothing matches</span></span><br><span class="line">    <span class="keyword">this</span>.params = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">this</span>.path = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.regexp.fast_slash) &#123;</span><br><span class="line">    <span class="comment">// fast path non-ending match for / (everything matches)</span></span><br><span class="line">    <span class="keyword">this</span>.params = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.path = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 匹配 path</span></span><br><span class="line">  <span class="keyword">var</span> m = <span class="keyword">this</span>.regexp.exec(path);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">    <span class="keyword">this</span>.params = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">this</span>.path = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// store values</span></span><br><span class="line">  <span class="keyword">this</span>.params = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.path = m[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// keys 是在生成 this.regexp 中生成的，简单来说就是当路径有参数的时候就有值，否则就是空数组</span></span><br><span class="line">  <span class="keyword">var</span> keys = <span class="keyword">this</span>.keys;</span><br><span class="line">  <span class="comment">// 看前三行，params 为空对象</span></span><br><span class="line">  <span class="keyword">var</span> params = <span class="keyword">this</span>.params;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// m[0] 为路径本身，m[1] 以后的才是路径中的参数</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; m.length; i++) &#123;</span><br><span class="line">    <span class="comment">// keys 为 [&#123;name: 'xxx'...&#125;, &#123;name: 'yyy'...&#125;] 形式的数组，name 为参数的名字</span></span><br><span class="line">    <span class="comment">// 例如 /users/:userId 的 keys 为 [&#123;name: 'userId'...&#125;] </span></span><br><span class="line">    <span class="keyword">var</span> key = keys[i - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">var</span> prop = key.name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 相当于 decodeURIComponent(m[i])</span></span><br><span class="line">    <span class="keyword">var</span> val = decode_param(m[i]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把路径中匹配到的参数到保存到 params</span></span><br><span class="line">    <span class="keyword">if</span> (val !== <span class="literal">undefined</span> || !(hasOwnProperty.call(params, prop))) &#123;</span><br><span class="line">      params[prop] = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="decode_param_解析路径中的参数">decode_param 解析路径中的参数</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Decode param value.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;string&#125; val</span><br><span class="line"> * @return &#123;string&#125;</span><br><span class="line"> * @private</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 只在 layer.match 中使用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode_param</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> val !== <span class="string">'string'</span> || val.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err <span class="keyword">instanceof</span> <span class="built_in">URIError</span>) &#123;</span><br><span class="line">      err.message = <span class="string">'Failed to decode param \''</span> + val + <span class="string">'\''</span>;</span><br><span class="line">      err.status = err.statusCode = <span class="number">400</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Route">Route</h1><h2 id="构造函数-1">构造函数</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Initialize `Route` with the given `path`,</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;String&#125; path</span><br><span class="line"> * @public</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Route</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.path = path;</span><br><span class="line">  <span class="comment">// 在 route.VERB 中会修改这个属性，用于保存 layer </span></span><br><span class="line">  <span class="keyword">this</span>.stack = [];</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'new %s'</span>, path);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// route handlers for various http methods</span></span><br><span class="line">  <span class="comment">// Route.prototype[method] 中会通过 this.methods[method] = true 修改这个属性</span></span><br><span class="line">  <span class="keyword">this</span>.methods = &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Route-prototype-_handles_method_判断该路由是否能处理指定的_HTTP_方法"><code>Route.prototype._handles_method</code> 判断该路由是否能处理指定的 HTTP 方法</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Determine if the route handles a given method.</span><br><span class="line"> * @private</span><br><span class="line"> */</span></span><br><span class="line">Route.prototype._handles_method = <span class="function"><span class="keyword">function</span> <span class="title">_handles_method</span>(<span class="params">method</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 调用过 route.all(...) 时，this.methods._all 会变成 true</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.methods._all) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> name = method.toLowerCase();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name === <span class="string">'head'</span> &amp;&amp; !<span class="keyword">this</span>.methods[<span class="string">'head'</span>]) &#123;</span><br><span class="line">    name = <span class="string">'get'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Boolean</span>(<span class="keyword">this</span>.methods[name]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Route-prototype-_options_返回该路由支持的_HTTP_方法">Route.prototype._options 返回该路由支持的 HTTP 方法</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * @return &#123;Array&#125; supported HTTP methods</span><br><span class="line"> * @private</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line">Route.prototype._options = <span class="function"><span class="keyword">function</span> <span class="title">_options</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> methods = <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.methods);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// append automatic head</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.methods.get &amp;&amp; !<span class="keyword">this</span>.methods.head) &#123;</span><br><span class="line">    methods.push(<span class="string">'head'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">    <span class="comment">// make upper case</span></span><br><span class="line">    methods[i] = methods[i].toUpperCase();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> methods;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Route-prototype-dispatch_分发_req,_res">Route.prototype.dispatch 分发 req, res</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * dispatch req, res into this route</span><br><span class="line"> * @private</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Router.route 中会在创建 Layer 的时候调用这个方法，作为 Layer 的第三个参数</span></span><br><span class="line">Route.prototype.dispatch = <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">req, res, done</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 每次调用 next() 都会增加这个下标</span></span><br><span class="line">  <span class="keyword">var</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> stack = <span class="keyword">this</span>.stack;</span><br><span class="line">  <span class="comment">// 当该路由没有处理函数(handler)时，stack 是一个空数组</span></span><br><span class="line">  <span class="keyword">if</span> (stack.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> done();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> method = req.method.toLowerCase();</span><br><span class="line">  <span class="comment">// 对 head 方法进行特殊处理</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">'head'</span> &amp;&amp; !<span class="keyword">this</span>.methods[<span class="string">'head'</span>]) &#123;</span><br><span class="line">    method = <span class="string">'get'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为请求对象 req 添加 route 属性，指向该 route 实例</span></span><br><span class="line">  req.route = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义 next 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err &amp;&amp; err === <span class="string">'route'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> done();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stack 中保存的是 layer 的列表</span></span><br><span class="line">    <span class="keyword">var</span> layer = stack[idx++];</span><br><span class="line">    <span class="keyword">if</span> (!layer) &#123;</span><br><span class="line">      <span class="keyword">return</span> done(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// route.all 会把 layer.method 设置为 undefined</span></span><br><span class="line">    <span class="keyword">if</span> (layer.method &amp;&amp; layer.method !== method) &#123;</span><br><span class="line">      <span class="keyword">return</span> next(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      layer.handle_error(err, req, res, next);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      layer.handle_request(req, res, next);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Route-prototype[method]_&amp;&amp;_Route-prototype-all_为所有_HTTP_方法添加处理(handler)方法">Route.prototype[method] &amp;&amp; Route.prototype.all 为所有 HTTP 方法添加处理(handler)方法</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Add a handler for all HTTP verbs to this route.</span><br><span class="line"> *</span><br><span class="line"> * Behaves just like middleware and can respond or call `next`</span><br><span class="line"> * to continue processing.</span><br><span class="line"> *</span><br><span class="line"> * You can use multiple `.all` call to add multiple handlers.</span><br><span class="line"> *</span><br><span class="line"> *   function check_something(req, res, next)&#123;</span><br><span class="line"> *     next();</span><br><span class="line"> *   &#125;;</span><br><span class="line"> *</span><br><span class="line"> *   function validate_user(req, res, next)&#123;</span><br><span class="line"> *     next();</span><br><span class="line"> *   &#125;;</span><br><span class="line"> *</span><br><span class="line"> *   route</span><br><span class="line"> *   .all(validate_user)</span><br><span class="line"> *   .all(check_something)</span><br><span class="line"> *   .get(function(req, res, next)&#123;</span><br><span class="line"> *     res.send('hello world');</span><br><span class="line"> *   &#125;);</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;function&#125; handler</span><br><span class="line"> * @return &#123;Route&#125; for chaining</span><br><span class="line"> * @api public</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// route.all(...) 的实现</span></span><br><span class="line">Route.prototype.all = <span class="function"><span class="keyword">function</span> <span class="title">all</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 提取所有中间件， flatten 会把多维数组变成一维数组，即 [fn1, [fn2, fn3]] =&gt; [fn1, fn2, fn3]</span></span><br><span class="line">  <span class="keyword">var</span> handles = flatten(slice.call(<span class="built_in">arguments</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; handles.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> handle = handles[i];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查 handle 的类型，必须为 function</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> handle !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> type = toString.call(handle);</span><br><span class="line">      <span class="keyword">var</span> msg = <span class="string">'Route.all() requires callback functions but got a '</span> + type;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新建 layer</span></span><br><span class="line">    <span class="comment">// Layer(path, options, fn)</span></span><br><span class="line">    <span class="comment">// path 无论传什么，layer.path 都会是 undefined</span></span><br><span class="line">    <span class="keyword">var</span> layer = Layer(<span class="string">'/'</span>, &#123;&#125;, handle);</span><br><span class="line">    <span class="comment">// 注意，Route.prototype[method] 中这是是 layer.method = method;</span></span><br><span class="line">    layer.method = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// route._handles_method 中会检查这个值</span></span><br><span class="line">    <span class="keyword">this</span>.methods._all = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 保存 layer</span></span><br><span class="line">    <span class="keyword">this</span>.stack.push(layer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本和 Route.prototype.all 一样</span></span><br><span class="line">methods.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>)</span>&#123;</span><br><span class="line">  Route.prototype[method] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handles = flatten(slice.call(<span class="built_in">arguments</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; handles.length; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> handle = handles[i];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> handle !== <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> type = toString.call(handle);</span><br><span class="line">        <span class="keyword">var</span> msg = <span class="string">'Route.'</span> + method + <span class="string">'() requires callback functions but got a '</span> + type;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(msg);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      debug(<span class="string">'%s %s'</span>, method, <span class="keyword">this</span>.path);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> layer = Layer(<span class="string">'/'</span>, &#123;&#125;, handle);</span><br><span class="line">      <span class="comment">// 和 .all 中不一样</span></span><br><span class="line">      layer.method = method;</span><br><span class="line"></span><br><span class="line">  	  <span class="comment">// route._handles_method 中会检查这个值, route.dispatch 中也会用到，但作用只是检查 head 方法而已</span></span><br><span class="line">      <span class="keyword">this</span>.methods[method] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.stack.push(layer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Router">Router</h1><h2 id="构造函数-2">构造函数</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> proto = <span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> opts = options || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化时会调用 router.handle</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">router</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    router.handle(req, res, next);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mixin Router class functions</span></span><br><span class="line">  <span class="comment">// 把 router 的原型对象指向 proto</span></span><br><span class="line">  router.__proto__ = proto;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化属性</span></span><br><span class="line">  router.params = &#123;&#125;;</span><br><span class="line">  router._params = [];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 下面几个属性会传进在 router.route 中传进 layer 的 options 中</span></span><br><span class="line">  router.caseSensitive = opts.caseSensitive;</span><br><span class="line">  router.mergeParams = opts.mergeParams;</span><br><span class="line">  router.strict = opts.strict;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// stack 用于保存 route(其实是特殊的 layer)</span></span><br><span class="line">  <span class="comment">// 调用 router.route 或者 router.VERB 的时候会修改这个值</span></span><br><span class="line">  router.stack = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> router;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Router-handle_把_req，res_分发到_router_中">Router.handle 把 req，res 分发到 router 中</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Dispatch a req, res into the router.</span><br><span class="line"> * @private</span><br><span class="line"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 无返回值</span></span><br><span class="line">proto.handle = <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">req, res, out</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'dispatching %s %s'</span>, req.method, req.url);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于找查询字符串的下标，如果 url 中没有查询字符串，则 search = 0，下一行就用到了</span></span><br><span class="line">  <span class="keyword">var</span> search = <span class="number">1</span> + req.url.indexOf(<span class="string">'?'</span>);</span><br><span class="line">  <span class="comment">// 不含查询字符串的 url 的长度</span></span><br><span class="line">  <span class="keyword">var</span> pathlength = search ? search - <span class="number">1</span> : req.url.length;</span><br><span class="line">  <span class="comment">// 判断 url 是否为完全合格域名，不以 '/' 开头的，同时也必须包含 '://' 。</span></span><br><span class="line">  <span class="comment">// 如果满足条件，就返回 '://' 的下标 + 1， 否则为 0 </span></span><br><span class="line">  <span class="keyword">var</span> fqdn = req.url[<span class="number">0</span>] !== <span class="string">'/'</span> &amp;&amp; <span class="number">1</span> + req.url.substr(<span class="number">0</span>, pathlength).indexOf(<span class="string">'://'</span>);</span><br><span class="line">  <span class="comment">// 如果是完全合格域名，就返回该域名。</span></span><br><span class="line">  <span class="comment">// 实现上是直接找 URI 中 host 后面的斜杠，即 https://www.baidu.com/ &lt;-- 这斜杠</span></span><br><span class="line">  <span class="keyword">var</span> protohost = fqdn ? req.url.substr(<span class="number">0</span>, req.url.indexOf(<span class="string">'/'</span>, <span class="number">2</span> + fqdn)) : <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> removed = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> slashAdded = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> paramcalled = &#123;&#125;; </span><br><span class="line"></span><br><span class="line">  <span class="comment">// store options for OPTIONS request</span></span><br><span class="line">  <span class="comment">// only used if OPTIONS request</span></span><br><span class="line">  <span class="comment">// 只用于 http 请求方法中的 options 方法</span></span><br><span class="line">  <span class="keyword">var</span> options = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// middleware and routes</span></span><br><span class="line">  <span class="comment">// 获取 self.stack 的引用，这里面保存的都是 layer，即中间件和 route</span></span><br><span class="line">  <span class="keyword">var</span> stack = self.stack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// manage inter-router variables</span></span><br><span class="line">  <span class="keyword">var</span> parentParams = req.params;</span><br><span class="line">  <span class="keyword">var</span> parentUrl = req.baseUrl || <span class="string">''</span>;</span><br><span class="line">  <span class="comment">// restore(fn, obj)，用于重新保存除 fn, obj 以外的其他参数，返回一个函数</span></span><br><span class="line">  <span class="comment">// 这里就是重新保存 baseUrl, next, params</span></span><br><span class="line">  <span class="comment">// done 现在是一个函数，重新保存上面提到的属性之后，会调用 out 函数</span></span><br><span class="line">  <span class="keyword">var</span> done = restore(out, req, <span class="string">'baseUrl'</span>, <span class="string">'next'</span>, <span class="string">'params'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setup next layer</span></span><br><span class="line">  req.next = next;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for options requests, respond with a default if nothing else responds</span></span><br><span class="line">  <span class="comment">// 为 options 请求方法返回一个默认的响应</span></span><br><span class="line">  <span class="comment">// wrap(old, fn) 函数只是简单包装一下，fn 的第一个参数会变成 old，其他参数照旧</span></span><br><span class="line">  <span class="comment">// sendOptionsResponse 里面会调用 res.send，这样下面的代码就不会执行了。</span></span><br><span class="line">  <span class="keyword">if</span> (req.method === <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">    done = wrap(done, <span class="function"><span class="keyword">function</span>(<span class="params">old, err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err || options.length === <span class="number">0</span>) <span class="keyword">return</span> old(err);</span><br><span class="line">      sendOptionsResponse(res, options, old);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setup basic req values</span></span><br><span class="line">  req.baseUrl = parentUrl;</span><br><span class="line">  req.originalUrl = req.originalUrl || req.url;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> layerError = err === <span class="string">'route'</span></span><br><span class="line">      ? <span class="literal">null</span></span><br><span class="line">      : err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// remove added slash</span></span><br><span class="line">    <span class="comment">// slashAdded 默认为 false</span></span><br><span class="line">    <span class="keyword">if</span> (slashAdded) &#123;</span><br><span class="line">      req.url = req.url.substr(<span class="number">1</span>);</span><br><span class="line">      slashAdded = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// restore altered req.url</span></span><br><span class="line">    <span class="keyword">if</span> (removed.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      req.baseUrl = parentUrl;</span><br><span class="line">      req.url = protohost + removed + req.url.substr(protohost.length);</span><br><span class="line">      removed = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// no more matching layers</span></span><br><span class="line">    <span class="keyword">if</span> (idx &gt;= stack.length) &#123;</span><br><span class="line">      setImmediate(done, layerError);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get pathname of request</span></span><br><span class="line">    <span class="comment">// 获取请求中的路径，即</span></span><br><span class="line">    <span class="comment">// protocol :// hostname[:port] / path / [;parameters][?query]#fragment</span></span><br><span class="line">    <span class="comment">// 中的 path 部分</span></span><br><span class="line">    <span class="keyword">var</span> path = getPathname(req);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> done(layerError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find next matching layer</span></span><br><span class="line">    <span class="keyword">var</span> layer;</span><br><span class="line">    <span class="keyword">var</span> match;</span><br><span class="line">    <span class="keyword">var</span> route;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们知道，router.stack 中保存了很多 layer，这些 layer 都是对应某个 url 的</span></span><br><span class="line">    <span class="comment">// 这里就是要通过 while 循环来找到和 path 对应的 layer</span></span><br><span class="line">    <span class="keyword">while</span> (match !== <span class="literal">true</span> &amp;&amp; idx &lt; stack.length) &#123;</span><br><span class="line">      layer = stack[idx++];</span><br><span class="line">      <span class="comment">// 这里封装了 layer.match(path); 为它添加了 try...catch</span></span><br><span class="line">      <span class="comment">// layer.path 就是匹配的值了</span></span><br><span class="line">      match = matchLayer(layer, path);</span><br><span class="line">      <span class="comment">// 还记得吗？router.route 中新建 layer 时会给 layer 添加 route 属性</span></span><br><span class="line">      route = layer.route;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  match 应该都是 boolean 的，不知道哪里会出错</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> match !== <span class="string">'boolean'</span>) &#123;</span><br><span class="line">        <span class="comment">// hold on to layerError</span></span><br><span class="line">        layerError = layerError || match;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果路径不匹配，就不会执行下面的代码了，继续下一轮循环</span></span><br><span class="line">      <span class="keyword">if</span> (match !== <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 没有 route ，就没有处理函数(handler)</span></span><br><span class="line">      <span class="comment">// 估计这句是为了兼容 router.VERB(...) 的</span></span><br><span class="line">      <span class="keyword">if</span> (!route) &#123;</span><br><span class="line">        <span class="comment">// process non-route handlers normally</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 处理 layerError</span></span><br><span class="line">      <span class="keyword">if</span> (layerError) &#123;</span><br><span class="line">        <span class="comment">// routes do not match with a pending error</span></span><br><span class="line">        match = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> method = req.method;</span><br><span class="line">      <span class="comment">// 用来判断该 route 是否有处理 method 的方法，返回 boolean</span></span><br><span class="line">      <span class="keyword">var</span> has_method = route._handles_method(method);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// build up automatic options response</span></span><br><span class="line">      <span class="keyword">if</span> (!has_method &amp;&amp; method === <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">        <span class="comment">// options 原本是一个空数组</span></span><br><span class="line">        <span class="comment">// route._options() 返回的是该 route 支持的方法</span></span><br><span class="line">        <span class="comment">// appendMethods 可以理解成 options = [].concat(route._options())</span></span><br><span class="line">        <span class="comment">// options 数组里面不会有重复的方法</span></span><br><span class="line">        appendMethods(options, route._options());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// don't even bother matching route</span></span><br><span class="line">      <span class="comment">// 注意 HEAD 方法是不会执行下面的代码的</span></span><br><span class="line">      <span class="keyword">if</span> (!has_method &amp;&amp; method !== <span class="string">'HEAD'</span>) &#123;</span><br><span class="line">        match = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// no match</span></span><br><span class="line">    <span class="comment">// 路径不匹配就直接 return ，不在执行下面的代码了</span></span><br><span class="line">    <span class="keyword">if</span> (match !== <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> done(layerError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// store route for dispatch on change</span></span><br><span class="line">    <span class="comment">// 为 req 添加 route 属性</span></span><br><span class="line">    <span class="keyword">if</span> (route) &#123;</span><br><span class="line">      req.route = route;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Capture one-time layer values</span></span><br><span class="line">    <span class="comment">// self.mergeParams 是在 Router 的构造函数中通过 opts 传进来的，默认值为 false</span></span><br><span class="line">    <span class="comment">// 默认情况下会以 layer.params 优先</span></span><br><span class="line">    req.params = self.mergeParams</span><br><span class="line">      ? mergeParams(layer.params, parentParams)</span><br><span class="line">      : layer.params;</span><br><span class="line">    <span class="keyword">var</span> layerPath = layer.path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this should be done for the layer</span></span><br><span class="line">    self.process_params(layer, paramcalled, req, res, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> next(layerError || err);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 把 req，res，next 分发到后续的中间件，或者是我们的业务逻辑</span></span><br><span class="line">      <span class="keyword">if</span> (route) &#123;</span><br><span class="line">        <span class="keyword">return</span> layer.handle_request(req, res, next);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      trim_prefix(layer, layerError, layerPath, path);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 确保 path 是以 / 开头的</span></span><br><span class="line">  <span class="comment">// 确保 req.baseUrl 不是以 / 结尾</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">trim_prefix</span>(<span class="params">layer, layerError, layerPath, path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> c = path[layerPath.length];</span><br><span class="line">    <span class="keyword">if</span> (c &amp;&amp; <span class="string">'/'</span> !== c &amp;&amp; <span class="string">'.'</span> !== c) <span class="keyword">return</span> next(layerError);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Trim off the part of the url that matches the route</span></span><br><span class="line">     <span class="comment">// middleware (.use stuff) needs to have the path stripped</span></span><br><span class="line">    <span class="keyword">if</span> (layerPath.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      debug(<span class="string">'trim prefix (%s) from url %s'</span>, layerPath, req.url);</span><br><span class="line">      removed = layerPath;</span><br><span class="line">      req.url = protohost + req.url.substr(protohost.length + removed.length);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Ensure leading slash</span></span><br><span class="line">      <span class="keyword">if</span> (!fqdn &amp;&amp; req.url[<span class="number">0</span>] !== <span class="string">'/'</span>) &#123;</span><br><span class="line">        req.url = <span class="string">'/'</span> + req.url;</span><br><span class="line">        slashAdded = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Setup base URL (no trailing slash)</span></span><br><span class="line">      req.baseUrl = parentUrl + (removed[removed.length - <span class="number">1</span>] === <span class="string">'/'</span></span><br><span class="line">        ? removed.substring(<span class="number">0</span>, removed.length - <span class="number">1</span>)</span><br><span class="line">        : removed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">'%s %s : %s'</span>, layer.name, layerPath, req.originalUrl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (layerError) &#123;</span><br><span class="line">      layer.handle_error(layerError, req, res, next);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      layer.handle_request(req, res, next);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Router-param_获取指定参数的值">Router.param 获取指定参数的值</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Map the given param placeholder `name`(s) to the given callback.</span><br><span class="line"> *</span><br><span class="line"> * Parameter mapping is used to provide pre-conditions to routes</span><br><span class="line"> * which use normalized placeholders. For example a _:user_id_ parameter</span><br><span class="line"> * could automatically load a user's information from the database without</span><br><span class="line"> * any additional code,</span><br><span class="line"> *</span><br><span class="line"> * The callback uses the same signature as middleware, the only difference</span><br><span class="line"> * being that the value of the placeholder is passed, in this case the _id_</span><br><span class="line"> * of the user. Once the `next()` function is invoked, just like middleware</span><br><span class="line"> * it will continue on to execute the route, or subsequent parameter functions.</span><br><span class="line"> *</span><br><span class="line"> * Just like in middleware, you must either respond to the request or call next</span><br><span class="line"> * to avoid stalling the request.</span><br><span class="line"> *</span><br><span class="line"> *  app.param('user_id', function(req, res, next, id)&#123;</span><br><span class="line"> *    User.find(id, function(err, user)&#123;</span><br><span class="line"> *      if (err) &#123;</span><br><span class="line"> *        return next(err);</span><br><span class="line"> *      &#125; else if (!user) &#123;</span><br><span class="line"> *        return next(new Error('failed to load user'));</span><br><span class="line"> *      &#125;</span><br><span class="line"> *      req.user = user;</span><br><span class="line"> *      next();</span><br><span class="line"> *    &#125;);</span><br><span class="line"> *  &#125;);</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;String&#125; name</span><br><span class="line"> * @param &#123;Function&#125; fn</span><br><span class="line"> * @return &#123;app&#125; for chaining</span><br><span class="line"> * @public</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个方法并不会调用 fn，实际调用 fn 的是 router.handle</span></span><br><span class="line">proto.param = <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params">name, fn</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// param logic</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">'function'</span>) &#123;</span><br><span class="line">    deprecate(<span class="string">'router.param(fn): Refactor to use path params'</span>);</span><br><span class="line">    <span class="keyword">this</span>._params.push(name);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// apply param functions</span></span><br><span class="line">  <span class="keyword">var</span> params = <span class="keyword">this</span>._params;</span><br><span class="line">  <span class="keyword">var</span> len = params.length;</span><br><span class="line">  <span class="keyword">var</span> ret;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 兼容旧写法，旧的写法支持参数以 : 开头，新的写法不需要以 : 开头</span></span><br><span class="line">  <span class="keyword">if</span> (name[<span class="number">0</span>] === <span class="string">':'</span>) &#123;</span><br><span class="line">    deprecate(<span class="string">'router.param('</span> + <span class="built_in">JSON</span>.stringify(name) + <span class="string">', fn): Use router.param('</span> + <span class="built_in">JSON</span>.stringify(name.substr(<span class="number">1</span>)) + <span class="string">', fn) instead'</span>);</span><br><span class="line">    name = name.substr(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ret = params[i](name, fn)) &#123;</span><br><span class="line">      fn = ret;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ensure we end up with a</span></span><br><span class="line">  <span class="comment">// middleware function</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'function'</span> != <span class="keyword">typeof</span> fn) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'invalid param() call for '</span> + name + <span class="string">', got '</span> + fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  (<span class="keyword">this</span>.params[name] = <span class="keyword">this</span>.params[name] || []).push(fn);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Router-process_params_为_layer_处理参数">Router.process_params 为 layer 处理参数</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Process any parameters for the layer.</span><br><span class="line"> * @private</span><br><span class="line"> */</span></span><br><span class="line"> <span class="comment">// 这个方法里面定义了两个函数，param(err) 和 paramCallback(err)</span></span><br><span class="line"> <span class="comment">// 先执行 param()，如果执行过程报错，就会调用 param(err) 来处理错误</span></span><br><span class="line"> <span class="comment">// 如果没有报错，就会调用 paramCallback()</span></span><br><span class="line"> <span class="comment">// 如果执行过程中报错，就会调用 paramCallback(err) 来处理错误</span></span><br><span class="line"> <span class="comment">// 其实 paramCallback(err) 内部也是调用 param(err) 来处理错误的</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"> <span class="comment">// 这个方法应该是用来处理 router.param(name, fn) 的</span></span><br><span class="line"> <span class="comment">// 因为 router.param 并没有处理参数，而是把 fn 添加到 router.params[name] 中</span></span><br><span class="line"> <span class="comment">// 实际上调用 fn 的是下面这个方法</span></span><br><span class="line">proto.process_params = <span class="function"><span class="keyword">function</span> <span class="title">process_params</span>(<span class="params">layer, called, req, res, done</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> params = <span class="keyword">this</span>.params;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// captured parameters from the layer, keys and values</span></span><br><span class="line">  <span class="comment">// 初始化 layer 的时候会通过 pathRegexp() 来定义 layer.keys</span></span><br><span class="line">  <span class="comment">// 这里的 keys 是 url 中的参数</span></span><br><span class="line">  <span class="comment">// 如 /:foo/:bar/baz 的 keys 就是 [&#123;name: 'foo'...&#125;, &#123;name: 'bar'...&#125;]</span></span><br><span class="line">  <span class="keyword">var</span> keys = layer.keys;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fast track</span></span><br><span class="line">  <span class="comment">// 没有 keys 的话就不需要处理参数了，直接调用回调函数</span></span><br><span class="line">  <span class="keyword">if</span> (!keys || keys.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> done();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于遍历 keys 的下标</span></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// key.name，即 url 中的参数名</span></span><br><span class="line">  <span class="keyword">var</span> name;</span><br><span class="line">  <span class="comment">// 每次调用 param() 都会把 paramIndex 清零</span></span><br><span class="line">  <span class="keyword">var</span> paramIndex = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> key;</span><br><span class="line">  <span class="comment">// url 中对应参数的实际值</span></span><br><span class="line">  <span class="keyword">var</span> paramVal;</span><br><span class="line">  <span class="keyword">var</span> paramCallbacks;</span><br><span class="line">  <span class="comment">// 下面的 paramCalled 的结构是在 param(err) 函数结束前定义的，形式为:</span></span><br><span class="line">  <span class="comment">// &#123; error: null, match: val, value: val &#125;</span></span><br><span class="line">  <span class="keyword">var</span> paramCalled;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// process params in order</span></span><br><span class="line">  <span class="comment">// param callbacks can be async</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> done(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= keys.length ) &#123;</span><br><span class="line">      <span class="keyword">return</span> done();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    paramIndex = <span class="number">0</span>;</span><br><span class="line">    key = keys[i++];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">      <span class="keyword">return</span> done();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    name = key.name;</span><br><span class="line">    paramVal = req.params[name];</span><br><span class="line">    <span class="comment">// params 即 this.params</span></span><br><span class="line">    <span class="comment">// 翻了一下代码，只有 router.param(name, fn) 会修改这个值</span></span><br><span class="line">    <span class="comment">// 难道这行是为了处理 router.param 的？</span></span><br><span class="line">    <span class="comment">// 另外， params[name] 会返回一个数组，里面包含 fn</span></span><br><span class="line">    paramCallbacks = params[name];</span><br><span class="line">    <span class="comment">// called 是在 router.handle 传进来的，默认为 &#123;&#125;</span></span><br><span class="line">    <span class="comment">// 该值会在本函数递归调用时修改</span></span><br><span class="line">    paramCalled = called[name];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (paramVal === <span class="literal">undefined</span> || !paramCallbacks) &#123;</span><br><span class="line">      <span class="keyword">return</span> param();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// param previously called with same value or error occurred</span></span><br><span class="line">    <span class="keyword">if</span> (paramCalled &amp;&amp; (paramCalled.match === paramVal</span><br><span class="line">      || (paramCalled.error &amp;&amp; paramCalled.error !== <span class="string">'route'</span>))) &#123;</span><br><span class="line">      <span class="comment">// restore value</span></span><br><span class="line">      req.params[name] = paramCalled.value;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// next param</span></span><br><span class="line">      <span class="keyword">return</span> param(paramCalled.error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    called[name] = paramCalled = &#123;</span><br><span class="line">      error: <span class="literal">null</span>,</span><br><span class="line">      match: paramVal,</span><br><span class="line">      value: paramVal</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    paramCallback();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// single param callbacks</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">paramCallback</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// paramCallbacks 是通过 this.params[name] 来得到的，是一个保存了 fn 的数组</span></span><br><span class="line">    <span class="keyword">var</span> fn = paramCallbacks[paramIndex++];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// store updated value</span></span><br><span class="line">    paramCalled.value = req.params[key.name];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="comment">// store error</span></span><br><span class="line">      paramCalled.error = err;</span><br><span class="line">      param(err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fn) <span class="keyword">return</span> param();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      fn(req, res, paramCallback, paramVal, key.name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      paramCallback(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  param();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Router-use_加载特定中间件">Router.use 加载特定中间件</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Use the given middleware function, with optional path, defaulting to "/".</span><br><span class="line"> *</span><br><span class="line"> * Use (like `.all`) will run for any http METHOD, but it will not add</span><br><span class="line"> * handlers for those methods so OPTIONS requests will not consider `.use`</span><br><span class="line"> * functions even if they could respond.</span><br><span class="line"> *</span><br><span class="line"> * The other difference is that _route_ path is stripped and not visible</span><br><span class="line"> * to the handler function. The main effect of this feature is that mounted</span><br><span class="line"> * handlers can operate without any code changes regardless of the "prefix"</span><br><span class="line"> * pathname.</span><br><span class="line"> *</span><br><span class="line"> * @public</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间件默认挂载在 / 下</span></span><br><span class="line">proto.use = <span class="function"><span class="keyword">function</span> <span class="title">use</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> offset = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> path = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// default path to '/'</span></span><br><span class="line">  <span class="comment">// disambiguate router.use([fn])</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> arg = fn;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">Array</span>.isArray(arg) &amp;&amp; arg.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      arg = arg[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// first arg is the path</span></span><br><span class="line">    <span class="comment">// 处理 router.use('/foo', bar)</span></span><br><span class="line">    <span class="comment">// 注意这里只是设置了偏移值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> arg !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      offset = <span class="number">1</span>;</span><br><span class="line">      path = fn;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 .use 中所有函数</span></span><br><span class="line">  <span class="comment">// 如 router.use('/test', fn1, fn2, fn3); </span></span><br><span class="line">  <span class="comment">// callbacks = [fn1, fn2, fn3]</span></span><br><span class="line">  <span class="keyword">var</span> callbacks = flatten(slice.call(<span class="built_in">arguments</span>, offset));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (callbacks.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Router.use() requires middleware functions'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 callbacks，每个 callback 都会成为一个 layer，并按顺序进入 Router.stack</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> fn = callbacks[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Router.use() requires middleware function but got a '</span> + gettype(fn));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add the middleware</span></span><br><span class="line">    debug(<span class="string">'use %s %s'</span>, path, fn.name || <span class="string">'&lt;anonymous&gt;'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> layer = <span class="keyword">new</span> Layer(path, &#123;</span><br><span class="line">      sensitive: <span class="keyword">this</span>.caseSensitive,</span><br><span class="line">      strict: <span class="literal">false</span>,</span><br><span class="line">      end: <span class="literal">false</span></span><br><span class="line">    &#125;, fn);</span><br><span class="line"></span><br><span class="line">    layer.route = <span class="literal">undefined</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.stack.push(layer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Router-route_为_router_创建新的路由">Router.route 为 router 创建新的路由</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Create a new Route for the given path.</span><br><span class="line"> *</span><br><span class="line"> * Each route contains a separate middleware stack and VERB handlers.</span><br><span class="line"> *</span><br><span class="line"> * See the Route api documentation for details on adding handlers</span><br><span class="line"> * and middleware to routes.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;String&#125; path</span><br><span class="line"> * @return &#123;Route&#125;</span><br><span class="line"> * @public</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line">proto.route = <span class="function"><span class="keyword">function</span> <span class="title">route</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建新的路由</span></span><br><span class="line">  <span class="keyword">var</span> route = <span class="keyword">new</span> Route(path);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建新的 layer</span></span><br><span class="line">  <span class="keyword">var</span> layer = <span class="keyword">new</span> Layer(path, &#123;</span><br><span class="line">    sensitive: <span class="keyword">this</span>.caseSensitive,</span><br><span class="line">    strict: <span class="keyword">this</span>.strict,</span><br><span class="line">    end: <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为这个特殊的 layer 提供分发 req，res 的能力</span></span><br><span class="line">  &#125;, route.dispatch.bind(route));</span><br><span class="line"></span><br><span class="line">  layer.route = route;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 其实 route 也是一个 layer</span></span><br><span class="line">  <span class="keyword">this</span>.stack.push(layer);</span><br><span class="line">  <span class="keyword">return</span> route;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Router-VERB_为_router_提供_VERB_方法">Router.VERB 为 router 提供 VERB 方法</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// create Router#VERB functions</span></span><br><span class="line"><span class="comment">// 提供方便的语法来创建 route</span></span><br><span class="line">methods.concat(<span class="string">'all'</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>)</span>&#123;</span><br><span class="line">  proto[method] = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 只是简单的调用上面提到的 Router.route</span></span><br><span class="line">    <span class="keyword">var</span> route = <span class="keyword">this</span>.route(path)</span><br><span class="line">    route[method].apply(route, slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="helpers_只有_Router_中才用到的_helpers，属于私有_API">helpers 只有 Router 中才用到的 helpers，属于私有 API</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// append methods to a list of methods</span></span><br><span class="line"><span class="comment">// 为给定列表添加不重复的元素</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">appendMethods</span>(<span class="params">list, addition</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; addition.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> method = addition[i];</span><br><span class="line">    <span class="keyword">if</span> (list.indexOf(method) === -<span class="number">1</span>) &#123;</span><br><span class="line">      list.push(method);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get pathname of request</span></span><br><span class="line"><span class="comment">// 获取请求中的 pathname</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPathname</span>(<span class="params">req</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parseUrl(req).pathname;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get type for error message</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gettype</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> type = <span class="keyword">typeof</span> obj;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type !== <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// inspect [[Class]] for objects</span></span><br><span class="line">  <span class="keyword">return</span> toString.call(obj)</span><br><span class="line">    .replace(objectRegExp, <span class="string">'$1'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Match path to a layer.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;Layer&#125; layer</span><br><span class="line"> * @param &#123;string&#125; path</span><br><span class="line"> * @private</span><br><span class="line"> */</span></span><br><span class="line"><span class="comment">// 判断给定的 layer 是否与路径匹配</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchLayer</span>(<span class="params">layer, path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> layer.match(path);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// merge params with parent params</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeParams</span>(<span class="params">params, parent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> parent !== <span class="string">'object'</span> || !parent) &#123;</span><br><span class="line">    <span class="keyword">return</span> params;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make copy of parent for base</span></span><br><span class="line">  <span class="keyword">var</span> obj = mixin(&#123;&#125;, parent);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// simple non-numeric merging</span></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="number">0</span> <span class="keyword">in</span> params) || !(<span class="number">0</span> <span class="keyword">in</span> parent)) &#123;</span><br><span class="line">    <span class="keyword">return</span> mixin(obj, params);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> o = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// determine numeric gaps</span></span><br><span class="line">  <span class="keyword">while</span> (i <span class="keyword">in</span> params) &#123;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (o <span class="keyword">in</span> parent) &#123;</span><br><span class="line">    o++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// offset numeric indices in params before merge</span></span><br><span class="line">  <span class="keyword">for</span> (i--; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    params[i + o] = params[i];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create holes for the merge when necessary</span></span><br><span class="line">    <span class="keyword">if</span> (i &lt; o) &#123;</span><br><span class="line">      <span class="keyword">delete</span> params[i];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mixin(obj, params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// restore obj props after function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restore</span>(<span class="params">fn, obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> props = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="built_in">arguments</span>.length - <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">var</span> vals = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="built_in">arguments</span>.length - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; props.length; i++) &#123;</span><br><span class="line">    props[i] = <span class="built_in">arguments</span>[i + <span class="number">2</span>];</span><br><span class="line">    vals[i] = obj[props[i]];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// restore vals</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; props.length; i++) &#123;</span><br><span class="line">      obj[props[i]] = vals[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// send an OPTIONS response</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendOptionsResponse</span>(<span class="params">res, options, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> body = options.join(<span class="string">','</span>);</span><br><span class="line">    res.set(<span class="string">'Allow'</span>, body);</span><br><span class="line">    res.send(body);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    next(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// wrap a function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrap</span>(<span class="params">old, fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="built_in">arguments</span>.length + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    args[<span class="number">0</span>] = old;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="built_in">arguments</span>.length; i &lt; len; i++) &#123;</span><br><span class="line">      args[i + <span class="number">1</span>] = <span class="built_in">arguments</span>[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fn.apply(<span class="keyword">this</span>, args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/08/20/2015-08-20-expressjs-source-code-learning-Application/" itemprop="url">
                  ExpressJS 源码学习 —— Application 篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-08-20T10:11:10+08:00" content="2015-08-20">
              2015-08-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/20/2015-08-20-expressjs-source-code-learning-Application/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/20/2015-08-20-expressjs-source-code-learning-Application/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="概述">概述</h1><p>ExpressJS 是 NodeJS 世界中使用最广泛的 Web 框架。它非常轻量，最大的特点是可以组合各种各样的中间件来处理请求，每个中间件都会对请求进行处理，最后再返回给客户端。目前最新版的 ExpressJS 是 4.13.3。</p>
<p>这系列的文章是出于学习目的而写的，主要是想了解目前主流的 JavaScript 框架是如何设计的，使用了哪些我还不知道的技术。希望写完这系列的文章之后，对我自己的水平会有一定的提高。这系列的文章会先分析各个模块的 API 的工作流程，最后再作总结。</p>
<p>本文先从 application.js 文件开始分析。</p>
<h1 id="私有_API">私有 API</h1><ul>
<li><p><code>app.init</code> 对 app 进行初始化</p>
<ul>
<li><p>初始化 <code>cache</code>, <code>engines</code>, <code>settings</code> 为 <code>{}</code></p>
</li>
<li><p>调用 <code>this.defaultConfiguration</code> 来设置 app 的默认配置。</p>
</li>
</ul>
</li>
<li><p><code>app.defaultConfiguration</code> 设置 app 的默认配置</p>
<ul>
<li><p>启用 <code>x-powered-by</code> (<code>middleware/init</code>这个中间件会用到)</p>
</li>
<li><p>调用 <code>this.set</code> 来设置 <code>etag</code>, <code>env</code>, <code>query parser</code>, <code>subdomain offset</code>, <code>trust proxy</code>, <code>view</code>, <code>views</code>, <code>jsonp callback name</code> 等属性</p>
</li>
<li><p>初始化 <code>this.locals</code></p>
</li>
<li><p>为 <code>production</code> 环境启用 <code>view cache</code></p>
</li>
<li><p>禁止用户直接访问 <code>app.router</code></p>
</li>
<li><p>监听 <code>mount</code> 事件，该事件会在调用 <code>app.use</code> 时触发</p>
</li>
<li><p>很奇怪为什么一个普通的 <code>Object</code> 为什么可以监听和发送事件吧？想想就知道这个 <code>Object</code> 要么就继承了 <code>EventEmitter</code>，要么就和 <code>EventEmitter</code> 合并了。答案是后者，详细见 <code>express.js</code> 这个文件。</p>
</li>
</ul>
</li>
<li><p><code>app.lazyrouter</code> 初始化 Router, 只会执行一次</p>
<ul>
<li><p>初始化 Router</p>
</li>
<li><p>为这个 Router 添加 <code>query</code> 和 <code>init</code> 这两个中间件。</p>
</li>
<li><p>把这个 API 放在 <code>defaultConfiguration</code> 之外是因为这个方法会读取 <code>settings</code>，如果把它放到 <code>defaultConfiguration</code> 中就会忽略用户的设置直接运行。试想，当你调用 <code>var app = express()</code> 的时候，默认的路由就已经新建好了，这时候你再怎么用 <code>app.set(xxx)</code> 也没效果的。</p>
</li>
</ul>
</li>
<li><p><code>app.handle(req, res, callback)</code> 用来把 <code>req</code>, <code>res</code>, <code>callback</code> 交给 Router 来处理</p>
<ul>
<li><p>检查是否带有 <code>callback</code>，如果没有就提供一个默认的 <code>callback</code></p>
</li>
<li><p>检查是否已经初始化过 Router，如果没有就不会传递参数给 Router</p>
</li>
</ul>
</li>
<li><p><code>app.path()</code> 返回绝对路径，看源码吧</p>
</li>
</ul>
<h1 id="公开_API">公开 API</h1><ul>
<li><p><code>app.use(fn)</code> 挂载中间件，代理到 <code>Router.use</code></p>
<ul>
<li><p>初始化 <code>offer</code>, <code>path</code></p>
</li>
<li><p>根据 <code>fn</code> 来调整 <code>offset</code> (要兼容 <code>app.use([path1, path2, path3...], fn1, [fn2, fn3...])</code> 这种语法)</p>
</li>
<li><p>通过 <code>slice.call(arguments, offset)</code> 获取传入的所有函数，保存到 <code>fns</code> 中</p>
</li>
<li><p>初始化 Router</p>
</li>
<li><p>遍历 <code>fns</code>, 挂载所有 <code>fn</code></p>
</li>
<li><p>通过 <code>this.emit(&#39;mount&#39;, this)</code> 的形式发送 <code>mount</code> 事件 (<code>app.defaultConfiguration</code> 会监听这个事件)</p>
</li>
</ul>
</li>
<li><p><code>app.render(name, options, callback)</code> 渲染指定名字的页面，<code>callback</code> 中返回渲染后的模板字符串</p>
<ul>
<li><p>初始化 <code>cache</code>，<code>engine</code>，<code>renderOptions</code></p>
</li>
<li><p>把 <code>this.locals</code>，<code>options._locals</code>，<code>options</code> 合并到 <code>renderOptions</code> 中</p>
</li>
<li><p>根据 <code>this.settings[&#39;view cache&#39;]</code> 来判断是否需要缓存 <code>view</code>，在生产环境下，该值默认为 <code>true</code> (在 <code>defaultConfiguration</code> 设置的默认值)</p>
</li>
<li><p>如果需要渲染的 <code>view</code> 已经缓存过，就直接找到该 <code>view</code> 对象，否则就生成 <code>view</code> 对象。</p>
</li>
<li><p>尝试去渲染 <code>view</code> 对象。PS：渲染过程在 <code>View</code> 模块中实现的</p>
</li>
</ul>
</li>
<li><p><code>app.route(path)</code> 代理到 <code>Router.route(path)</code></p>
</li>
<li><p><code>app.param(name, fn)</code> 代理到 <code>Router.param(name, fn)</code></p>
<ul>
<li>如果 <code>name</code> 参数为 <code>Array</code>，则会递归调用该函数</li>
</ul>
</li>
<li><p><code>app.engine(ext, fn)</code> 注册模板引擎</p>
<ul>
<li><p>必须传入 <code>fn</code>，且 <code>fn</code> 必须是函数</p>
</li>
<li><p>解析 <code>ext</code> 参数，会确保 <code>ext</code> 前面带有 <code>.</code>，即如果传入 <code>ejs</code>，它会帮你转换成 <code>.ejs</code>。在实现上只是简单判断第一个字符是不是 <code>.</code></p>
</li>
<li><p>把解析过的 <code>ext</code> 和 <code>fn</code> 以 <code>key</code> 和 <code>value</code> 的形式添加到 <code>this.engines</code> 中</p>
</li>
</ul>
</li>
<li><p><code>app.set(setting, val)</code> 设置相关属性值</p>
<ul>
<li><p>如果传入一个参数，就去获取相关的属性值。<code>app.get(setting)</code> 就是这样实现的</p>
</li>
<li><p>传入两个值的话，就会用 <code>this.settings[setting] = val</code> 的形式来设置值</p>
</li>
<li><p><code>etag</code>，<code>query parser</code>，<code>trust proxy</code> 并不是用上面的形式来设置的，具体请看源码</p>
</li>
</ul>
</li>
<li><p><code>app.get(setting)</code> 获取相关属性值</p>
<ul>
<li><p>事实上，就如上面 <code>app.set</code> 中所说，并没有通过 <code>app.get(setting)</code> 这种形式来设计这个 API</p>
</li>
<li><p>由于 <code>get</code> 也是 HTTP 请求方法中的一个，所以它被放在 <code>app.VERB</code> 中实现了，但对它做过特殊处理。看下面的 <code>app.VERB</code> 吧。</p>
</li>
</ul>
</li>
<li><p><code>app.VERB(...)</code> 委托 <code>.VERB</code> 去调用 <code>Router.VERB</code></p>
<ul>
<li><p><code>methods</code> 是一个含有最常用的 HTTP 请求方法的列表，如 <code>[&#39;get&#39;, &#39;post&#39;, &#39;put&#39;, &#39;delete&#39; ...]</code></p>
</li>
<li><p>遍历 <code>methods</code>，把每一个方法名都代理到 Router</p>
</li>
<li><p>对 <code>get</code> 进行特殊处理：如果方法名为 <code>get</code>，而且参数只有一个，就去调用 <code>this.set(xxx)</code></p>
</li>
</ul>
</li>
<li><p><code>app.all(path)</code></p>
<ul>
<li><p>初始化 Router</p>
</li>
<li><p>通过 <code>route[method].apply(route, args)</code> 来实现本功能</p>
</li>
</ul>
</li>
<li><p><code>app.enable(setting)</code> 把 <code>setting</code> 设置为 <code>true</code></p>
<ul>
<li>通过 <code>this.set(setting, true)</code> 来实现</li>
</ul>
</li>
<li><p><code>app.disable(setting)</code> 把 <code>setting</code> 设置为 <code>false</code></p>
<ul>
<li>通过 <code>this.set(setting, false)</code> 来实现</li>
</ul>
</li>
<li><p><code>app.enabled(setting)</code> 验证 <code>setting</code> 是否为 <code>true</code></p>
<ul>
<li>通过 <code>Boolean(this.set(setting))</code> 来实现</li>
</ul>
</li>
<li><p><code>app.disabled(setting)</code> 验证 <code>setting</code> 是否为 <code>false</code></p>
<ul>
<li>通过 <code>!this.set(setting)</code> 来实现</li>
</ul>
</li>
<li><p><code>app.listen</code> 创建服务器</p>
</li>
</ul>
<h1 id="学习心得">学习心得</h1><ul>
<li><p>ExpressJS 本质上就是让我们根据自己需要去配置 <code>app</code> 对象。</p>
</li>
<li><p><code>fn.call(target, param)</code> 和 <code>fn.apply(target, args)</code> 配合 <code>Array.prototype.slice.apply(argument, offset)</code> 可以很好的调节参数。这一点在 ExpressJS 中大量使用。</p>
</li>
<li><p>实现挂载中间件的方法和我预想不一样，我原本以为 <code>app.use</code> 简单添加到一个数组里面，然后按顺序执行这些中间件，结果原来是通过事件机制来实现的。</p>
</li>
<li><p>涉及到 Router 的地方还没看懂，等到时候再来补一补。</p>
</li>
</ul>
<h1 id="参考资料">参考资料</h1><p><a href="https://github.com/strongloop/express" target="_blank" rel="external">https://github.com/strongloop/express</a><br><a href="http://expressjs.com/api.html" target="_blank" rel="external">http://expressjs.com/api.html</a><br><a href="https://cnodejs.org/topic/545720506537f4d52c414d87" target="_blank" rel="external">https://cnodejs.org/topic/545720506537f4d52c414d87</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/08/19/2015-08-19-commonjs-learning/" itemprop="url">
                  CommonJS 学习笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-08-19T10:11:10+08:00" content="2015-08-19">
              2015-08-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/19/2015-08-19-commonjs-learning/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/19/2015-08-19-commonjs-learning/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="概述">概述</h1><p>CommonJS 是 JavaScript 模块化的规范，Node.js采用了这个规范。</p>
<p>根据 CommonJS 规范，一个 JavaScript 文件就是一个模块，其他模块可以通过 <code>require</code> 来获取 <code>module.exports</code> 中暴露的内容，而其他部分都是私有的，其他模块不能访问。</p>
<h1 id="module_对象">module 对象</h1><p>每个模块都有一个module变量，该变量指向当前模块。module不是全局变量，而是每个模块都有的本地变量。</p>
<ul>
<li><p><code>module.id</code> 模块的识别符，通常是带有绝对路径的模块文件名。</p>
</li>
<li><p><code>module.filename</code> 模块的文件名。</p>
</li>
<li><p><code>module.loaded</code> 返回一个布尔值，表示模块是否已经完成加载。</p>
</li>
<li><p><code>module.parent</code> 返回一个对象，表示调用该模块的模块。</p>
</li>
<li><p><code>module.children</code> 返回一个数组，表示该模块要用到的其他模块。数组中的内容是其他要用到的模块的 <code>module</code> 对象。</p>
</li>
<li><p><code>module.paths</code> 返回一个数组，表示模块查找路径，排在越前面的优先级越高。具体请查看 <a href="http://www.infoq.com/cn/articles/nodejs-module-mechanism/" target="_blank" rel="external">这里</a></p>
</li>
<li><p><code>module.exports</code> 表示其他模块可以通过 <code>require</code> 获取的内容。默认情况下是一个空对象，即 <code>{}</code>。</p>
</li>
</ul>
<h1 id="module-exports_和_exports">module.exports 和 exports</h1><p>默认情况下，<code>module.exports</code> 和 <code>exports</code> 两者是等价的，即 <code>module.exports === exports</code></p>
<p><code>exports</code> 只是为了方便我们编码而添加的，相当于在每个文件中自动添加了 <code>var exports = module.exports</code>。</p>
<p>我们可以根据个人喜好，把需要暴露的东西挂在 <code>exports</code> 或 <code>module.exports</code> 下。</p>
<p><strong>但是</strong>，必须注意以下几点：</p>
<ul>
<li><p>不能把 <code>exports</code> 重新赋值，因为这样会令 <code>exports</code> 不再指向 <code>module.exports</code>，这样 <code>exports</code> 就没用了。</p>
</li>
<li><p>我们可以通过 <code>module.exports = function() {...}</code> 这种方式指定 <code>module.exports</code> 的指向，这样在其他模块中 <code>require</code> 这个模块，获得的就是一个 <code>function</code>，而不是一个对象。这样做也会导致 <code>exports</code> 失效。</p>
</li>
<li><p>由于上面的原因，我们会在很多地方看到 <code>module.exports = exports = xxx</code> 这样的代码。</p>
</li>
</ul>
<h1 id="参考资料">参考资料</h1><p><a href="http://javascript.ruanyifeng.com/nodejs/commonjs.html" target="_blank" rel="external">http://javascript.ruanyifeng.com/nodejs/commonjs.html</a><br><a href="http://www.infoq.com/cn/articles/nodejs-module-mechanism/" target="_blank" rel="external">http://www.infoq.com/cn/articles/nodejs-module-mechanism/</a><br><a href="http://stackoverflow.com/questions/7137397/module-exports-vs-exports-in-node-js" target="_blank" rel="external">http://stackoverflow.com/questions/7137397/module-exports-vs-exports-in-node-js</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/08/18/2015-08-18-Object-learning-in-javascript/" itemprop="url">
                  JavaScript 中 Object.defineProperty 的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-08-18T17:57:31+08:00" content="2015-08-18">
              2015-08-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/18/2015-08-18-Object-learning-in-javascript/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/18/2015-08-18-Object-learning-in-javascript/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Object-defineProperty">Object.defineProperty</h1><blockquote>
<p>The Object.defineProperty() method defines a new property directly on an object, or modifies an existing property on an object, and returns the object.</p>
</blockquote>
<p>直接在一个对象上定义一个新的属性，或修改一个已经存在的属性。这个方法会返回该对象。</p>
<h3 id="语法">语法</h3><p><code>Object.defineProperty(obj, prop, descriptor)</code></p>
<h3 id="参数">参数</h3><ul>
<li><p><code>Object obj</code> 目标对象</p>
</li>
<li><p><code>String prop</code> 需要定义的属性</p>
</li>
<li><p><code>Object descriptor</code> 该属性拥有的特性，可设置的值有：</p>
<ul>
<li><p><code>value</code> 属性的值，默认为 <code>undefined</code>。</p>
</li>
<li><p><code>writable</code> 该属性是否可写，如果设置成 <code>false</code>，则任何对该属性改写的操作都无效（但不会报错），默认为 <code>false</code>。</p>
</li>
<li><p><code>get</code> 一旦目标对象访问该属性，就会调用这个方法，并返回结果。默认为 <code>undefined</code>。</p>
</li>
<li><p><code>set</code> 一旦目标对象设置该属性，就会调用这个方法。默认为 <code>undeinfed</code>。</p>
</li>
<li><p><code>configurable</code> 如果为false，则任何尝试删除目标属性或修改属性以下特性（writable, configurable, enumerable）的行为将被无效化，默认为 <code>false</code>。</p>
</li>
<li><p><code>enumerable</code> 是否能在for…in循环中遍历出来或在Object.keys中列举出来。默认为 <code>false</code>。</p>
</li>
</ul>
</li>
</ul>
<h4 id="注意"><strong>注意</strong></h4><p>在 <code>descriptor</code> 中不能<strong>同时</strong>设置访问器 (<code>get</code> 和 <code>set</code>) 和 <code>wriable</code> 或 <code>value</code>，否则会报以下错误：<br><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">Invalid <span class="keyword">property</span>.  A <span class="keyword">property</span> cannot both have accessors <span class="keyword">and</span> be writable <span class="keyword">or</span> have a value</span><br></pre></td></tr></table></figure></p>
<h3 id="实际应用">实际应用</h3><p>我们知道，在 <code>Express.js</code> 升级到 4.0 之后，它把很多功能从核心库中移除了。当我们访问那些被移除的属性时，它会报错，告诉我们该属性已经被移除了。这个功能就是通过 <code>Object.defineProperty</code> 来实现的。看看源码吧：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="string">'json'</span>,</span><br><span class="line">  <span class="string">'urlencoded'</span>,</span><br><span class="line">  <span class="string">'bodyParser'</span>,</span><br><span class="line">  <span class="string">'compress'</span>,</span><br><span class="line">  <span class="string">'cookieSession'</span>,</span><br><span class="line">  <span class="string">'session'</span>,</span><br><span class="line">  <span class="string">'logger'</span>,</span><br><span class="line">  <span class="string">'cookieParser'</span>,</span><br><span class="line">  <span class="string">'favicon'</span>,</span><br><span class="line">  <span class="string">'responseTime'</span>,</span><br><span class="line">  <span class="string">'errorHandler'</span>,</span><br><span class="line">  <span class="string">'timeout'</span>,</span><br><span class="line">  <span class="string">'methodOverride'</span>,</span><br><span class="line">  <span class="string">'vhost'</span>,</span><br><span class="line">  <span class="string">'csrf'</span>,</span><br><span class="line">  <span class="string">'directory'</span>,</span><br><span class="line">  <span class="string">'limit'</span>,</span><br><span class="line">  <span class="string">'multipart'</span>,</span><br><span class="line">  <span class="string">'staticCache'</span>,</span><br><span class="line">].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(exports, name, &#123;</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Most middleware (like '</span> + name + <span class="string">') is no longer bundled with Express and must be installed separately. Please see https://github.com/senchalabs/connect#middleware.'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    configurable: <span class="literal">true</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="Object-defineProperties">Object.defineProperties</h1><blockquote>
<p>The Object.defineProperties() method defines new or modifies existing properties directly on an object, returning the object.</p>
</blockquote>
<p>和 <code>Object.defineProperty</code> 类似，只不过这个方法可以设置多个属性。</p>
<h3 id="语法-1">语法</h3><p><code>Object.defineProperties(obj, props)</code></p>
<h3 id="参数-1">参数</h3><ul>
<li><p><code>Object obj</code> 目标对象</p>
</li>
<li><p><code>Object props</code> 要为目标对象添加的属性，其中 <code>key</code> 和 <code>value</code> 分别代表 <code>Object.defineProperty</code> 中的第二和第三个参数。</p>
</li>
</ul>
<h1 id="参考资料">参考资料</h1><p><a href="http://www.cnblogs.com/rubylouvre/archive/2010/09/19/1831128.html" target="_blank" rel="external">http://www.cnblogs.com/rubylouvre/archive/2010/09/19/1831128.html</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object" target="_blank" rel="external">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object</a><br><a href="https://github.com/strongloop/express/blob/master/lib/express.js" target="_blank" rel="external">https://github.com/strongloop/express/blob/master/lib/express.js</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/08/14/2015-08-14-use-gulp-for-front-end-workflow/" itemprop="url">
                  利用 Gulp 处理前端工作流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-08-14T16:57:33+08:00" content="2015-08-14">
              2015-08-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/14/2015-08-14-use-gulp-for-front-end-workflow/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/14/2015-08-14-use-gulp-for-front-end-workflow/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="基本用法">基本用法</h1><figure class="highlight openscad"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gulpfile.js</span></span><br><span class="line">gulp.task<span class="params">('foo', function<span class="params">()</span> &#123;</span><br><span class="line">    gulp.src<span class="params">(glob)</span></span><br><span class="line">        .pipe<span class="params">(...)</span></span><br><span class="line">        .pipe<span class="params">(...)</span></span><br><span class="line">        .pipe<span class="params">(gulp.dest<span class="params">(...)</span>)</span></span><br><span class="line">        .pipe<span class="params">(...)</span></span><br><span class="line">        .pipe<span class="params">(gulp.dest<span class="params">(...)</span>)</span></span><br><span class="line">&#125;)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shell</span></span><br><span class="line">$ gulp foo</span><br></pre></td></tr></table></figure>
<h1 id="基本_API">基本 API</h1><ul>
<li><p><code>gulp.src(glob[, options])</code></p>
<ul>
<li>根据 <code>glob</code> 匹配文件，返回 <code>stream</code>，可以通过 <code>.pipe()</code> 方法传递给后续的插件。</li>
</ul>
</li>
<li><p><code>gulp.dest(path[, options])</code></p>
<ul>
<li><p>一般用法 <code>.pipe(gulp.dest(path))</code>，把 <code>pipe</code> 中的内容按照指定的 <code>path</code> 写成文件，会自动创建不存在的文件夹。</p>
</li>
<li><p>注意，可以通过 <code>.pipe</code> 多次指定输出的地方，具体请看 <a href="https://github.com/gulpjs/gulp/blob/master/docs/API.md#gulpdestpath-options" target="_blank" rel="external">这里</a></p>
</li>
</ul>
</li>
<li><p><code>gulp.task(name[, deps], fn)</code></p>
<ul>
<li><p>定义名为 <code>name</code> 的任务，定义之后就可以在命令行中使用 <code>gulp xxx</code> 来执行任务。</p>
</li>
<li><p><code>deps</code> 里面的任务全部完成后才会执行 <code>fn</code></p>
</li>
<li><p><code>deps</code> 里面的任务都是并行执行的，如果需要顺序执行，需要特殊写法。具体看 <a href="https://github.com/gulpjs/gulp/blob/master/docs/API.md#return-a-promise" target="_blank" rel="external">这里</a></p>
</li>
</ul>
</li>
<li><p><code>gulp.watch(glob[, opts, cb])</code></p>
<ul>
<li><p>监听文件变化</p>
</li>
<li><p>根据<a href="http://stackoverflow.com/questions/22391527/gulps-gulp-watch-not-triggered-for-new-or-deleted-files" target="_blank" rel="external">这个帖子</a>，<code>gulp.watch</code> 不会监听新文件（目录），所以一般你会需要 <a href="https://github.com/floatdrop/gulp-watch" target="_blank" rel="external">gulp-watch</a></p>
</li>
</ul>
</li>
</ul>
<h1 id="常用命令_（自定义）">常用命令 （自定义）</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for development mode</span></span><br><span class="line">gulp server</span><br><span class="line"></span><br><span class="line"><span class="comment"># run test</span></span><br><span class="line">gulp <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for production mode</span></span><br><span class="line">gulp build</span><br></pre></td></tr></table></figure>
<h2 id="gulp_server_流程"><code>gulp server</code> 流程</h2><ul>
<li><p>把 <code>less</code>, <code>sass</code>, 之类的文件编译成 CSS，常用插件：</p>
<ul>
<li><p><a href="https://github.com/plus3network/gulp-less" target="_blank" rel="external">gulp-less</a></p>
</li>
<li><p><a href="https://github.com/dlmanning/gulp-sass" target="_blank" rel="external">gulp-sass</a></p>
</li>
</ul>
</li>
<li><p>创建 Web Server (with Live Reload)，常用：</p>
<ul>
<li><p><a href="https://github.com/AveVlad/gulp-connect" target="_blank" rel="external">gulp-connect</a>，用来创建 Web Server，其实还有其他选择的，但多数都是利用 <a href="https://github.com/senchalabs/connect" target="_blank" rel="external">connect</a> 来创建 Web Server 的。</p>
</li>
<li><p><a href="https://github.com/andrewrk/node-proxy-middleware" target="_blank" rel="external">node-proxy-middle</a>，用来代理请求，可以把 <code>/api/xxx</code> 发送到指定的地址。(常用于 SPA 开发)</p>
</li>
<li><p><a href="https://github.com/tinganho/connect-modrewrite" target="_blank" rel="external">connect-modrewrite</a>，匹配资源，如果不匹配就可以重定向到指定地址。(常用于 SPA 开发)</p>
</li>
<li><p><a href="https://github.com/bripkens/connect-history-api-fallback" target="_blank" rel="external">connect-history-api-fallback</a>，作用同上，也用于匹配资源，但用起来简单很多。(常用于 SPA 开发)</p>
</li>
</ul>
</li>
<li><p>监听文件变化，常用插件：</p>
<ul>
<li><a href="https://github.com/floatdrop/gulp-watch" target="_blank" rel="external">gulp-watch</a></li>
</ul>
</li>
</ul>
<h3 id="示例代码">示例代码</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">gulp.task(<span class="string">'clean:css'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    del.sync(<span class="string">'app/styles/*.css'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'less'</span>, [<span class="string">'clean:css'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> stream = gulp</span><br><span class="line">            .src(<span class="string">'app/styles/main.less'</span>)</span><br><span class="line">            .pipe(less())</span><br><span class="line">            .pipe(gulp.dest(<span class="string">'app/styles/'</span>));</span><br><span class="line">    <span class="keyword">return</span> stream;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'connect'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    connect.server(&#123;</span><br><span class="line">        root: <span class="string">'./app'</span>,</span><br><span class="line">        port: <span class="number">9000</span>,</span><br><span class="line">        livereload: <span class="literal">true</span>,</span><br><span class="line">        middleware: <span class="function"><span class="keyword">function</span> (<span class="params">connect, o</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line">                    <span class="keyword">var</span> proxy = <span class="built_in">require</span>(<span class="string">'proxy-middleware'</span>);</span><br><span class="line">                    <span class="keyword">var</span> options = url.parse(<span class="string">'http://localhost:3000/api'</span>);</span><br><span class="line">                    options.route = <span class="string">'/api'</span>;</span><br><span class="line">                    <span class="keyword">return</span> proxy(options);</span><br><span class="line">                &#125;)(),</span><br><span class="line">                modRewrite([</span><br><span class="line">                    <span class="string">'!\\.html|\\.js|\\.css|\\.swf|\\.jp(e?)g|\\.png|\\.gif|\\.eot|\\.woff|\\.ttf|\\.svg$ /index.html'</span></span><br><span class="line">                ])</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'watch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    gulp</span><br><span class="line">        .src(<span class="string">'app/styles/**/*.less'</span>, &#123;read: <span class="literal">false</span>&#125;)</span><br><span class="line">        .pipe(watch(<span class="string">'app/styles/**/*.less'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> gulp</span><br><span class="line">                .src(<span class="string">'app/styles/main.less'</span>)</span><br><span class="line">                .pipe(less())</span><br><span class="line">                .pipe(gulp.dest(<span class="string">'app/styles/'</span>))</span><br><span class="line">                .pipe(connect.reload());</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">    gulp</span><br><span class="line">        .src([<span class="string">'app/scripts/**/*.js'</span>, <span class="string">'app/**/*.html'</span>])</span><br><span class="line">        .pipe(watch([<span class="string">'app/scripts/**/*.js'</span>, <span class="string">'app/**/*.html'</span>]))</span><br><span class="line">        .pipe(plumber())</span><br><span class="line">        .pipe(connect.reload());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'server'</span>, [<span class="string">'less'</span>, <span class="string">'connect'</span>, <span class="string">'watch'</span>]);</span><br></pre></td></tr></table></figure>
<h2 id="gulp_build_流程"><code>gulp build</code> 流程</h2><ul>
<li><p>清理 <code>dist/</code> 文件夹</p>
<ul>
<li><a href="https://github.com/sindresorhus/del" target="_blank" rel="external">del</a>，根据 <code>glob</code> 来删除文件/目录</li>
</ul>
</li>
<li><p>压缩文件</p>
<ul>
<li><p><a href="https://github.com/jonschlinkert/gulp-htmlmin" target="_blank" rel="external">gulp-htmlmin</a>，压缩 <code>html</code> 文件</p>
</li>
<li><p><a href="https://github.com/murphydanger/gulp-minify-html" target="_blank" rel="external">gulp-minify-html</a>，同上</p>
</li>
<li><p><a href="https://github.com/chilijung/gulp-cssmin" target="_blank" rel="external">gulp-cssmin</a>，压缩 <code>css</code> 文件</p>
</li>
<li><p><a href="https://github.com/murphydanger/gulp-minify-css" target="_blank" rel="external">gulp-minify-css</a>，同上，封装了 <a href="https://github.com/jakubpawlowicz/clean-css" target="_blank" rel="external">clean-css</a>，star 比上面的多</p>
</li>
<li><p><a href="https://github.com/terinjokes/gulp-uglify" target="_blank" rel="external">gulp-uglify</a>，混淆 <code>JavaScript</code> 代码</p>
</li>
<li><p><a href="https://github.com/zont/gulp-usemin" target="_blank" rel="external">gulp-usemin</a>，合并指定 <code>block</code> 中的文件</p>
</li>
<li><p><a href="https://github.com/sindresorhus/gulp-rev" target="_blank" rel="external">gulp-rev</a>，给静态文件加上版本号，如 <code>app.js</code> -&gt; <code>app-d41d8cd98f.js</code></p>
</li>
</ul>
</li>
<li><p>复制其他文件到 <code>dist/</code></p>
<ul>
<li><code>gulp.src(...).pipe(gulp.dest(...))</code></li>
</ul>
</li>
</ul>
<h3 id="实例代码">实例代码</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">gulp.task(<span class="string">'clean:build'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    del.sync(<span class="string">'dist/'</span>, &#123;force: <span class="literal">true</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'minify'</span>, [<span class="string">'clean:build'</span>, <span class="string">'less'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    gulp</span><br><span class="line">        .src(<span class="string">'app/views/**/*.html'</span>)</span><br><span class="line">        .pipe(htmlmin(&#123;collapseWhitespace: <span class="literal">true</span>&#125;))</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'dist/views'</span>));</span><br><span class="line"></span><br><span class="line">    gulp</span><br><span class="line">        .src(<span class="string">'app/index.html'</span>)</span><br><span class="line">        .pipe(usemin(&#123;</span><br><span class="line">            js: [uglify(), rev()],</span><br><span class="line">            css: [minifyCss(), <span class="string">'concat'</span>, rev()]</span><br><span class="line">        &#125;))</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'dist/'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'copyfonts'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    gulp</span><br><span class="line">        .src(<span class="string">'app/styles/fonts/*'</span>)</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'dist/fonts/'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gulp.task(<span class="string">'build'</span>, [<span class="string">'clean:build'</span>, <span class="string">'minify'</span>, <span class="string">'copyfonts'</span>]);</span><br></pre></td></tr></table></figure>
<h1 id="参考资料">参考资料</h1><p><a href="https://github.com/gulpjs/gulp/blob/master/docs/API.md" target="_blank" rel="external">英文文档</a><br><a href="http://www.gulpjs.com.cn/docs/api/" target="_blank" rel="external">中文文档</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/08/11/2015-08-11-mongo-shell-trap/" itemprop="url">
                  Mongo Shell 使用过程中遇到的坑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-08-11T12:17:47+08:00" content="2015-08-11">
              2015-08-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mongodb/" itemprop="url" rel="index">
                    <span itemprop="name">mongodb</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/11/2015-08-11-mongo-shell-trap/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/11/2015-08-11-mongo-shell-trap/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="编写_js_脚本">编写 js 脚本</h1><ul>
<li><p>js 脚本中不能包含 <code>use</code> 关键字，需要用 <code>$ mongo mydb xxx.js</code> 这样的方式来指定数据库</p>
</li>
<li><p>不能用 <code>console.log</code>，需要用 <code>print</code> 代替</p>
</li>
<li><p>调用 <code>ObjectId()</code> 时需要确保传进去的值为字符串，否则会出现 <code>Error: invalid object id: length</code></p>
</li>
<li><p>使用 <code>$set</code> 来设置数字时需要注意，mongo shell 默认会把所有数字类型的值转换成浮点型，如果你需要插入整形，你需要用 <code>NumberInt()</code> 或 <code>NumberLong()</code> 来代替。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$ mongo mydb test.js</span><br><span class="line"></span><br><span class="line"><span class="comment">// test.js</span></span><br><span class="line"><span class="keyword">var</span> users = db.users.find(&#123;&#125;);</span><br><span class="line">users.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">u</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// not console.log(u._id) !!</span></span><br><span class="line">    <span class="comment">// use print instead of console!</span></span><br><span class="line">    print(u._id);</span><br><span class="line"></span><br><span class="line">    db.users.update(&#123;</span><br><span class="line">        _id: ObjectId(<span class="string">''</span> + u._id) <span class="comment">// make sure the params is string</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        $set: &#123;</span><br><span class="line">            money: NumberInt(<span class="number">100</span>) <span class="comment">// it will be int, not float.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="参考资料">参考资料</h1><p><a href="http://stackoverflow.com/questions/8218484/mongodb-inserts-float-when-trying-to-insert-integer" target="_blank" rel="external">http://stackoverflow.com/questions/8218484/mongodb-inserts-float-when-trying-to-insert-integer</a></p>
<p><a href="http://docs.mongodb.org/manual/core/shell-types/" target="_blank" rel="external">http://docs.mongodb.org/manual/core/shell-types/</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/08/07/2015-08-07-interview-summary/" itemprop="url">
                  面试总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-08-07T21:32:41+08:00" content="2015-08-07">
              2015-08-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/07/2015-08-07-interview-summary/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/07/2015-08-07-interview-summary/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="面试前的准备">面试前的准备</h1><ul>
<li><p>了解该公司的业务</p>
<ul>
<li>如果不了解的话，面试的时候 HR 们那些一系列专业的术语会让你头晕</li>
</ul>
</li>
<li><p>想清楚你为什么不去投其他公司（如BAT）</p>
</li>
<li><p>想清楚该公司哪些方面吸引你，常见的有</p>
<ul>
<li><p>办公环境优雅</p>
</li>
<li><p>技术先进</p>
</li>
<li><p>工作自由</p>
</li>
<li><p>福利待遇好</p>
</li>
<li><p>业务熟悉</p>
</li>
</ul>
</li>
<li><p>想清楚你要问的问题，常见的有</p>
<ul>
<li><p>期望工资（互联网行业跳槽一般涨幅 10% ~ 20% —— By 某 HR）</p>
</li>
<li><p>试用期长度</p>
</li>
<li><p>工作情况（几点上下班，一周上几天，加班怎么办）</p>
</li>
<li><p>各种制度（打卡，加班，调休，激励，补助）</p>
</li>
<li><p>是否社保（五险一金）</p>
</li>
</ul>
</li>
<li><p>想清楚你目前公司产品（你参与过的项目）的状况</p>
<ul>
<li><p>优点</p>
</li>
<li><p>缺点</p>
</li>
<li><p>当初选择这种架构/技术的原因</p>
</li>
<li><p>是否出现过问题？怎么解决？</p>
</li>
</ul>
</li>
<li><p>想清楚你问什么要离开现在的公司</p>
<ul>
<li><p>自身发展（技术，业务）达到瓶颈？</p>
</li>
<li><p>待遇不佳</p>
</li>
<li><p>工作强度大</p>
</li>
<li><p>为了更好的待遇</p>
</li>
</ul>
</li>
<li><p>想清楚你想加入什么样的公司/团队（你理想中的公司/团队是怎样的）</p>
<ul>
<li><p>所处的行业</p>
</li>
<li><p>技术水平</p>
</li>
<li><p>为什么</p>
</li>
</ul>
</li>
</ul>
<h1 id="面试中">面试中</h1><ul>
<li><p>介绍自己</p>
<ul>
<li><p>谈谈自己的成长经历</p>
</li>
<li><p>谈谈自己对未来的期待</p>
</li>
</ul>
</li>
<li><p>聊面试前准备的问题，相互问答。注意几点：</p>
<ul>
<li><p>不要紧张</p>
</li>
<li><p>想清楚，组织清楚语言再回答</p>
</li>
</ul>
</li>
<li><p>你觉得刚才的 HR 怎么样？（多轮面试下会问到），注意：</p>
<ul>
<li><p>不要无中生有</p>
</li>
<li><p>回答尽量圆滑</p>
</li>
</ul>
</li>
</ul>
<h1 id="面试后">面试后</h1><ul>
<li><p>冷静下来，再次思考</p>
<ul>
<li><p>新公司和旧公司之间的差别</p>
</li>
<li><p>跳槽的目的</p>
</li>
<li><p>跳槽是否有必要</p>
</li>
</ul>
</li>
<li><p>衡量跳槽的成本</p>
<ul>
<li><p>搬家成本（如果需要搬家的话）</p>
</li>
<li><p>交通成本</p>
</li>
<li><p>适应新环境所需时间</p>
</li>
<li><p>是否会带来其他问题</p>
</li>
</ul>
</li>
<li><p>做出决定</p>
</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/07/05/2015-07-06-android-support-design-library-experience/" itemprop="url">
                  Android Support Design Library 注意事项
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-07-05T23:45:02+08:00" content="2015-07-05">
              2015-07-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/05/2015-07-06-android-support-design-library-experience/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/05/2015-07-06-android-support-design-library-experience/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="CoordinatorLayout">CoordinatorLayout</h1><p>这个新 Layout 是 FrameLayout 的加强版，用来协调各个子 view 的行为。最主要是用来实现 Toolbar 的折叠效果，也可以用来实现 FAB 自动消失的效果。</p>
<p>常见的用法如下：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">&lt;android<span class="class">.support</span><span class="class">.design</span><span class="class">.widget</span><span class="class">.CoordinatorLayout</span></span><br><span class="line">    xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    xmlns:app=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">    android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">    android:layout_height=<span class="string">"match_parent"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;android<span class="class">.support</span><span class="class">.v4</span><span class="class">.widget</span><span class="class">.NestedScrollView</span></span><br><span class="line">        xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">        xmlns:app=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">        android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">        android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">        android:layout_gravity=<span class="string">"fill_vertical"</span></span><br><span class="line">        android:layout_marginBottom=<span class="string">"?attr/actionBarSize"</span></span><br><span class="line">        android:<span class="attribute">background</span>=<span class="string">"@android:color/white"</span></span><br><span class="line">        app:layout_behavior=<span class="string">"@string/appbar_scrolling_view_behavior"</span></span><br><span class="line">        &gt;</span><br><span class="line"></span><br><span class="line">        &lt;FrameLayout</span><br><span class="line">            android:id=<span class="string">"@+id/frame_image_toolbar_content"</span></span><br><span class="line">            android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">            android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">            &gt;</span><br><span class="line">        &lt;/FrameLayout&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/android<span class="class">.support</span><span class="class">.v4</span><span class="class">.widget</span><span class="class">.NestedScrollView</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;android<span class="class">.support</span><span class="class">.design</span><span class="class">.widget</span><span class="class">.AppBarLayout</span></span><br><span class="line">        android:id=<span class="string">"@+id/appbar"</span></span><br><span class="line">        android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">        android:layout_height=<span class="string">"256dp"</span></span><br><span class="line">        android:theme=<span class="string">"@style/ThemeOverlay.AppCompat.Dark.ActionBar"</span>&gt;</span><br><span class="line"></span><br><span class="line">        &lt;android<span class="class">.support</span><span class="class">.design</span><span class="class">.widget</span><span class="class">.CollapsingToolbarLayout</span></span><br><span class="line">            android:id=<span class="string">"@+id/collapsing_toolbar_wrapper"</span></span><br><span class="line">            android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">            android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">            app:contentScrim=<span class="string">"?attr/colorPrimary"</span></span><br><span class="line">            app:expandedTitleMarginEnd=<span class="string">"64dp"</span></span><br><span class="line">            app:expandedTitleMarginStart=<span class="string">"48dp"</span></span><br><span class="line">            app:layout_scrollFlags=<span class="string">"scroll|exitUntilCollapsed"</span></span><br><span class="line">            &gt;</span><br><span class="line"></span><br><span class="line">            &lt;ImageView</span><br><span class="line">                android:id=<span class="string">"@+id/collapsing_toolbar_image"</span></span><br><span class="line">                android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">                android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">                android:scaleType=<span class="string">"centerCrop"</span></span><br><span class="line">                app:layout_collapseMode=<span class="string">"parallax"</span></span><br><span class="line">                /&gt;</span><br><span class="line"></span><br><span class="line">            &lt;android<span class="class">.support</span><span class="class">.v7</span><span class="class">.widget</span><span class="class">.Toolbar</span></span><br><span class="line">                android:id=<span class="string">"@+id/collapsing_toolbar"</span></span><br><span class="line">                android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">                android:layout_height=<span class="string">"?attr/actionBarSize"</span></span><br><span class="line">                app:layout_collapseMode=<span class="string">"pin"</span></span><br><span class="line">                app:theme=<span class="string">"@style/ThemeOverlay.AppCompat.Dark.ActionBar"</span></span><br><span class="line">                app:popupTheme=<span class="string">"@style/ThemeOverlay.AppCompat.Light"</span></span><br><span class="line">                /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/android<span class="class">.support</span><span class="class">.design</span><span class="class">.widget</span><span class="class">.CollapsingToolbarLayout</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/android<span class="class">.support</span><span class="class">.design</span><span class="class">.widget</span><span class="class">.AppBarLayout</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/android<span class="class">.support</span><span class="class">.design</span><span class="class">.widget</span><span class="class">.CoordinatorLayout</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>CollapsingToolbarLayout.setTitle 代替 Toolbar.setTitle</li>
<li>NestedScrollView 中必须添加 <code>app:layout_behavior=&quot;@string/appbar_scrolling_view_behavior&quot;</code> 属性之后，里面的内容才会位于 AppBarLayout 之下</li>
<li>NestedScrollView 中 <code>android:layout_gravity=&quot;fill_vertical&quot;</code> 和 <code>android:layout_marginBottom=&quot;?attr/actionBarSize&quot;</code> 属性不是必须的，但如果内容不够高，则内容会位于屏幕底部，而不是 AppBarLayout 下面。<code>layout_gravity=&quot;fill_vertical&quot;</code> 可以修复这个问题。</li>
</ul>
<h1 id="参考资料">参考资料</h1><p><a href="http://segmentfault.com/a/1190000002888109" target="_blank" rel="external">Android Support Design 中 CoordinatorLayout 与 Behaviors 初探</a><br><a href="http://stackoverflow.com/questions/30612310/android-nestedscrollview-has-wrong-size-after-applayout-behavior" target="_blank" rel="external">http://stackoverflow.com/questions/30612310/android-nestedscrollview-has-wrong-size-after-applayout-behavior</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2015/06/29/2015-06-29-recyclerview-basic-usage/" itemprop="url">
                  RecyclerView 基本用法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-06-29T20:55:00+08:00" content="2015-06-29">
              2015-06-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/06/29/2015-06-29-recyclerview-basic-usage/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/29/2015-06-29-recyclerview-basic-usage/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="基本用法">基本用法</h1><ul>
<li><p>在 XML 中添加 <code>&lt;android.support.v7.widget.RecyclerView/&gt;</code></p>
</li>
<li><p>编写继承 <code>RecyclerView.Adapter&lt;RecyclerViewAdapter.ViewHolder&gt;</code> 的 <code>Adapter</code></p>
<ul>
<li><code>Constructor</code></li>
<li>编写继承 <code>RecyclerView.ViewHolder</code> 的 <code>ViewHolder</code></li>
<li><code>onCreateViewHolder</code></li>
<li><code>onBindViewHolder</code></li>
<li><code>getItemCount</code></li>
</ul>
</li>
<li><p>设置 <code>RecyclerView</code></p>
<ul>
<li><code>setLayoutManager</code></li>
<li><code>setAdapter</code></li>
<li><code>setItemAnimator</code>(可选)</li>
<li><code>addItemDecoration</code>(可选)</li>
</ul>
</li>
</ul>
<h1 id="XML">XML</h1><p>新建 xml，添加 <code>RecyclerView</code>。</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">&lt;RelativeLayout xmlns:<span class="variable">android=</span><span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    xmlns:<span class="variable">fab=</span><span class="string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">    android:<span class="variable">orientation=</span><span class="string">"vertical"</span></span><br><span class="line">    android:<span class="variable">layout_width=</span><span class="string">"match_parent"</span></span><br><span class="line">    android:<span class="variable">layout_height=</span><span class="string">"match_parent"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;android.support.v7.widget.RecyclerView</span><br><span class="line">        android:<span class="variable">id=</span><span class="string">"@+id/my_recyclerview"</span></span><br><span class="line">        android:<span class="variable">layout_width=</span><span class="string">"match_parent"</span></span><br><span class="line">        android:<span class="variable">layout_height=</span><span class="string">"wrap_content"</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure>
<h1 id="ViewHolder">ViewHolder</h1><p>我们以前使用 <code>ListView</code> 的时候，会用以下的方式来提高 <code>ListView</code> 的性能:</p>
<ul>
<li>用 <code>convertView</code> 来减少 <code>LayoutInflater.inflate</code> 的使用</li>
<li>用 <code>ViewHolder</code> 来减少 <code>findViewById</code> 的使用</li>
</ul>
<p><code>RecyclerView</code> 标准化了 <code>ViewHolder</code> 来缓存昂贵 <code>findViewById</code> 的结果。</p>
<p>例子：</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> MyViewHolder <span class="keyword">extends</span> RecyclerView.ViewHolder &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TextView mTitle;</span><br><span class="line">    <span class="keyword">public</span> TextView mSubtitle;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyViewHolder</span> <span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(v);</span><br><span class="line">        mTitle = (TextView) v.findViewById(R.id.title);</span><br><span class="line">        mSubtitle = (TextView) v.findViewById(R.id.subtitle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PS: 一般 <code>ViewHolder</code> 会编写在 <code>Adapter</code> 的内部。</p>
<h1 id="Adapter">Adapter</h1><p>我们需要继承 <code>RecyclerView.Adapter&lt;RecyclerView.ViewHolder&gt;</code> 来编写我们自己的 <code>Adapter</code> 。编写我们自己的 <code>Adapter</code> 的时候，最重要的是要重写 <code>onCreateViewHolder</code> 和 <code>onBindViewHolder</code> 方法。</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">RecyclerView</span>.<span class="title">ViewHolder</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span> <span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">        View v = LayoutInflater.from(ctx).inflate(R.layout.my_adapter, parent, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ViewHolder(v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onBindViewHolder</span> <span class="params">(RecyclerView.ViewHolder h, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        MyViewHolder holder = (MyViewHolder) h;</span><br><span class="line">        holder.mTitle.setText(<span class="string">"This is my title"</span>);</span><br><span class="line">        holder.mSubtitle.setText(<span class="string">"This is my subtitle"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> data.<span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，在这个例子中我们的 <code>MyAdapter</code> 存放的是 <code>&lt;RecyclerView.ViewHolder&gt;</code>，所以在 <code>onCreateViewHolder</code> 中返回的也必须是 <code>&lt;RecyclerView.ViewHolder&gt;</code>，而在 <code>onBindViewHolder</code> 的回调中，我们拿到的也是 <code>RecyclerView.ViewHolder</code>，要把它强转成我们之前编写的 <code>MyViewHolder</code> 之后才能正常使用。</p>
<h1 id="RecyclerView">RecyclerView</h1><p>最后只要设置一下 <code>RecyclerView</code> 就能使用了。</p>
<figure class="highlight openscad"><table><tr><td class="code"><pre><span class="line">RecyclerView mRecyclerView = <span class="params">(RecyclerView)</span> findViewById<span class="params">(R.id.my_recyclerview)</span>;</span><br><span class="line">mRecyclerView.setLayoutManager<span class="params">(new LinearLayoutManager<span class="params">(this)</span>)</span>;</span><br><span class="line">mRecyclerView.setAdapter<span class="params">(adapter)</span>;</span><br></pre></td></tr></table></figure>
<h1 id="参考资料">参考资料</h1><p><a href="http://wobushi.ren/recyclerview.html" target="_blank" rel="external">RecyclerView全攻略</a><br><a href="http://blog.csdn.net/lmj623565791/article/details/45059587" target="_blank" rel="external">Android RecyclerView 使用完全解析 体验艺术般的控件</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


 </div>

        

        
      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Scarletsky" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Scarletsky</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">19</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">5</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Scarletsky</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"notes-iissnan"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.2" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {

      isMobile() && FastClick.attach(document.body);

      // Define Motion Sequence.
      motionIntegrator
        .add(motionMiddleWares.logo)
        .add(motionMiddleWares.menu)
        .add(motionMiddleWares.backToTop)
        .add(motionMiddleWares.postList)
        .add(motionMiddleWares.sidebar);

      // Bootstrap Motion.
      motionIntegrator.bootstrap();
    });
  </script>

  
  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
